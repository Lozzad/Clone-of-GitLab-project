<html>

<head>
    <title>place-based narratives</title>
	<script src="https://aframe.io/releases/0.9.1/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/1.6.2/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.rawgit.com/donmccurdy/aframe-extras/v6.0.0/dist/aframe-extras.js"></script>
    <script src="https://unpkg.com/xstate@4.5.0/dist/xstate.js"></script>

    <script src="./components/al-carousel.js"></script>
    <style>
    body{
        margin : 0px;
        overflow: hidden;
        font-family: sans-serif;
    }
    .hide {
        display: none;
    }
    #overlay {
        position: absolute;
        background: #000;
        top: 0;
        right: 0;
    }
    </style>
</head>

<body>

    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" vr-mode-ui="enabled: false" renderer="colorManagement: true;">
        <a-assets>
            <a-asset-item id="house-model" src="assets/model-house.glb"></a-asset-item>
        </a-assets>

        <a-entity 
            camera
            cursor="rayOrigin: mouse"
            raycaster="objects: .collidable;"
        ></a-entity>

        <a-marker preset="hiro">
            <a-light 
                type="ambient" 
                color="#fff" 
                position="0 1 0" 
                intensity="1"
            ></a-light>

            <a-light 
                type="spot" 
                position="0 2 4" 
                rotation="0 0 0" 
                intensity="2.5"
            ></a-light>

            <a-entity 
                id="house" 
                animation-mixer="clip: closed" 
                rotation="0 270 0" 
                position="0 0 -0.25" 
                scale="5 5 5"
                gltf-model="#house-model"
            >
                <a-entity
                    rotation="90 0 0"
                    id="carousel-controller"
                    position="0 0.1 0"
                    scale="0.01 0.01 0.01"
                >
                    <a-entity 
                        id="carousel"
                        al-carousel="items: 6; radius: 1; thickness: 0.01; ringVisible: true;"
                        animation="property: rotation; from: '90 0 0'; to: '90 0 180'; dur: 30000; loop: true; easing: linear; autoplay: true;"
                    >
                    </a-entity>  
                </a-entity>
            </a-entity>      
        </a-marker>
        
    </a-scene>

    <div id="overlay" class="hide">
        <iframe id="viewer" src="viewer.html" frameborder="0"></iframe>
    </div>

    <script>
        var scene = document.querySelector("a-scene");
        var house = document.querySelector("#house");
        var carousel = document.querySelector("#carousel-controller");

        var scene, video, overlay, viewer;
        var overlayVisible = false;

        function viewObjectInOverlay(src) {
            viewer.contentWindow.postMessage({
                src: src
            }, window.location.href);

            overlayVisible = true;

            render();
        }

        function resize() {
            overlay.width = window.innerWidth;
            overlay.height = window.innerHeight;
            viewer.width = window.innerWidth;
            viewer.height = window.innerHeight;
        }

        window.addEventListener("resize", function() {
            resize();
        });

        function render() {
            if (overlayVisible) {
                scene.classList.add("hide");
                document.querySelector("video").classList.add("hide");
                overlay.classList.remove("hide");
            } else {
                scene.classList.remove("hide");
                document.querySelector("video").classList.remove("hide");
                overlay.classList.add("hide");
            }
        }

        window.addEventListener("DOMContentLoaded", function() {
            scene = document.querySelector("a-scene");
            //video = document.querySelector("video");
            overlay = document.querySelector("#overlay");
            viewer = document.querySelector("#viewer");

            setTimeout(() => {
                viewObjectInOverlay("https://nomad-project.co.uk/objects/collection/toy-lion/_toy-lion/toy-lion.gltf");
            }, 5000);

            window.addEventListener("message", function(event) {
                if (event.data === "close") {
                    overlayVisible = false;
                    render();
                }
            }, false);

            resize();
        });

        // Define the animation constraints
        // =============================================================
        const duration = "6000";

        const scale_small = "0.01 0.01 0.01";
        const position_small = "0 0.1 0";

        const scale_large = "0.3 0.3 0.3";
        const position_large = "0 0.3 0";
        // =============================================================

        // Create the animation strings
        // =============================================================
        const scale_smallToLarge = "property: scale" +
        "; from: " + scale_small +
        "; to: " + scale_large +
        "; dur: " + duration +
        "; loop: once; autoplay: true;";

        const scale_largeToSmall = "property: scale" +
        "; from: " + scale_large +
        "; to: " + scale_small +
        "; dur: " + duration +
        "; loop: once; autoplay: true;";

        const position_smallToLarge = "property: position" +
        "; from: " + position_small +
        "; to: " + position_large +
        "; dur: " + duration +
        "; loop: once; autoplay: true;";

        const position_largeToSmall = "property: position" +
        "; from: " + position_large +
        "; to: " + position_small +
        "; dur: " + duration +
        "; loop: once; autoplay: true;";
        // =============================================================

        scene.addEventListener("click", function() {
            switch (currentState) {
                case state.CLOSED:
                    houseService.send(transition.OPEN);
                    carousel.setAttribute("animation__scale", scale_smallToLarge);
                    carousel.setAttribute("animation__position", position_smallToLarge);
                    break;
                case state.OPENED:
                    houseService.send(transition.CLOSE);
                    carousel.setAttribute("animation__scale", scale_largeToSmall);
                    carousel.setAttribute("animation__position", position_largeToSmall);
                    break;
            }
        });
    </script>
    <script src="./house.js"></script>
</body>

</html>