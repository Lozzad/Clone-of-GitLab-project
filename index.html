<html>

<head>
    <title>place-based narratives</title>
	<script src="https://aframe.io/releases/0.9.1/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/1.6.2/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.rawgit.com/donmccurdy/aframe-extras/v6.0.0/dist/aframe-extras.js"></script>
    <script src="https://unpkg.com/xstate@4.5.0/dist/xstate.js"></script>

    <script src="./components/al-carousel.js"></script>
    <script src="./components/al-look-to-camera.js"></script>
    <style>
    body{
        margin : 0px;
        padding: 0px;
        width: 100%;
        height: 100%;
        overflow: hidden;
        font-family: sans-serif;
    }
    .hide {
        display: none;
    }
    #overlay {
        position: absolute;
        background: #000;
        top: 0;
        right: 0;
    }
    </style>
</head>

<body>

    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" vr-mode-ui="enabled: false" renderer="colorManagement: true;">
        <a-assets>
            <a-asset-item id="house-asset" src="https://place-based-narratives.netlify.com/assets/model-house.glb"></a-asset-item>
            <a-asset-item id="letter-asset" src="https://place-based-narratives.netlify.com/assets/letter.gltf"></a-asset-item>
            <a-asset-item id="man-asset" src="https://place-based-narratives.netlify.com/assets/man.gltf"></a-asset-item>
            <a-asset-item id="signpost-asset" src="https://place-based-narratives.netlify.com/assets/signpost.gltf"></a-asset-item>
            <a-asset-item id="speech-bubble" src=""></a-asset-item>
        </a-assets>

        <a-entity camera>
            <a-entity raycaster="objects: .collidable"
                      cursor="fuse: false; rayOrigin: mouse"
                      position="0 0 -1"
                      geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                      material="color: black; shader: flat">
            </a-entity>
        </a-entity>

        <a-marker preset="hiro">
            <a-light 
                type="ambient" 
                color="#fff" 
                position="0 1 0" 
                intensity="1"
            ></a-light>

            <a-light 
                type="spot" 
                position="0 2 4" 
                rotation="0 0 0" 
                intensity="2.5"
            ></a-light>

            <a-entity 
                id="house" 
                class="collidable"
                animation-mixer="clip: closed" 
                rotation="0 270 0" 
                position="0 0 -0.25" 
                scale="5 5 5"
                gltf-model="#house-asset"
            >
            </a-entity>
            
            <a-entity
                rotation="90 0 0"
                id="carousel-controller"
                position="0 1 -0.25"
                scale="3 3 3"
            >
                <a-entity 
                    id="carousel"
                    al-carousel="radius: 0.6; thickness: 0.01; ringVisible: true; itemRadius: 0.1;"
                >
                <!--animation="property: rotation; from: '90 0 0'; to: '90 0 360'; dur: 30000; loop: true; easing: linear; autoplay: true;"-->
                    <a-entity 
                        id="letter" 
                        gltf-model="#letter-asset"
                        al-look-to-camera
                    >
                        <a-sphere class="collidable" color="yellow" radius="0.1"></a-sphere>
                        <!-- <a-entity
                            id="letter-text"
                            geometry="primitive: plane; width: 1; height: 1;"
                            position="0 0.05 0"
                            material="src: #speech-bubble"
                        >
                        </a-entity> -->
                    </a-entity>
                    <a-entity 
                        id="man" 
                        gltf-model="#man-asset"
                        al-look-to-camera
                    >
                        <a-sphere class="collidable" color="red" radius="0.1"></a-sphere>
                        <!-- <a-entity
                            id="man-text"
                            geometry="primitive: plane; width: 1; height: 1;"
                            position="0 0.05 0"
                            material="src: #speech-bubble"
                        >
                        </a-entity> -->
                    </a-entity>
                    <a-entity 
                        id="signpost" 
                        gltf-model="#signpost-asset"                        
                        al-look-to-camera
                    >
                        <a-sphere class="collidable" color="green" radius="0.1"></a-sphere>
                        <!-- <a-entity
                            id="signpost-text"
                            geometry="primitive: plane; width: 1; height: 1;"
                            position="0 0.05 0"
                            material="src: #speech-bubble"
                        >
                        </a-entity> -->
                    </a-entity>
                </a-entity>  
            </a-entity>
        </a-marker>
        
    </a-scene>

    <div id="overlay" class="hide">
        <iframe id="viewer" src="viewer.html" frameborder="0"></iframe>
    </div>

    <script>
        var scene, video, overlay, viewer;
        var overlayVisible = false;

        function viewObjectInOverlay(src) {
            viewer.contentWindow.postMessage({
                src: src
            }, window.location.href);

            overlayVisible = true;

            render();
        }

        function resize() {
            if (overlay) {
                overlay.width = window.innerWidth;
                overlay.height = window.innerHeight;
            }
            
            if (viewer) {
                viewer.width = window.innerWidth;
                viewer.height = window.innerHeight;
            }            
        }

        window.addEventListener("resize", function() {
            resize();
        });

        function render() {
            if (overlayVisible) {
                scene.classList.add("hide");
                document.querySelector("video").classList.add("hide");
                overlay.classList.remove("hide");
            } else {
                scene.classList.remove("hide");
                document.querySelector("video").classList.remove("hide");
                overlay.classList.add("hide");
            }
        }

        window.addEventListener("DOMContentLoaded", function() {
            scene = document.querySelector("a-scene");
            overlay = document.querySelector("#overlay");
            viewer = document.querySelector("#viewer");
            carousel = document.querySelector("#carousel-controller");

            scene.addEventListener("al-carousel-item-clicked", function(event) {
                var id = event.detail.id;
                var asset = document.getElementById(id + "-asset");

                if (asset) {
                    viewObjectInOverlay(asset.getAttribute("src"));
                }
            }, false);

            window.addEventListener("message", function(event) {
                if (event.data === "close") {
                    overlayVisible = false;
                    render();
                }
            }, false);

            resize();
        });
    </script>
    <script src="./scripts/house.js"></script>
    <script src="./scripts/carousel-listeners.js"></script>
</body>

</html>