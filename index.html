<html>

<head>
    <title>place-based narratives</title>
	<script src="https://aframe.io/releases/0.9.1/aframe.min.js"></script>
    <!-- <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/1.6.2/aframe/build/aframe-ar.js"></script> -->
    <script src="https://cdn.rawgit.com/donmccurdy/aframe-extras/v6.0.0/dist/aframe-extras.js"></script>
    <script src="https://unpkg.com/xstate@4.5.0/dist/xstate.js"></script>

    <script src="./components/al-carousel.js"></script>
    <style>
    body{
        margin : 0px;
        overflow: hidden;
        font-family: sans-serif;
    }
    </style>
</head>

<!-- arjs="sourceType: webcam; debugUIEnabled: false;" 
vr-mode-ui="enabled: false"  -->
<body>
    <a-scene 
        embedded 

        renderer="colorManagement: true;"
    >
        <a-assets>
            <a-asset-item id="house-model" src="assets/model-house.glb"></a-asset-item>
        </a-assets>

        <a-entity 
            camera
            look-controls
            wasd-controls
        ></a-entity>

        <!-- <a-marker preset="hiro"> -->
            <a-light 
                type="ambient" 
                color="#fff" 
                position="0 1 0" 
                intensity="1"
            ></a-light>

            <a-light 
                type="spot" 
                position="0 2 4" 
                rotation="0 0 0" 
                intensity="2.5"
            ></a-light>

            <a-entity 
                id="house" 
                animation-mixer="clip: closed" 
                rotation="0 270 0" 
                position="0 0 -0.25" 
                scale="5 5 5"
                gltf-model="#house-model"
            >
                <a-entity
                    rotation="90 0 0"
                    id="carousel-controller"
                    position="0 0.1 0"
                    scale="0.01 0.01 0.01"
                >
                    <a-entity 
                        id="carousel"
                        al-carousel="items: 6; radius: 1; thickness: 0.01; ringVisible: true;"
                        animation="property: rotation; from: '90 0 0'; to: '90 0 180'; dur: 30000; loop: true; easing: linear; autoplay: true;"
                    >
                    </a-entity>  
                </a-entity>
            </a-entity>      

        <!-- </a-marker> -->
    </a-scene>

    <script>
        var scene = document.querySelector("a-scene");
        var house = document.querySelector("#house");
        var carousel = document.querySelector("#carousel-controller");

        var state = {
            CLOSED: "closed",
            OPENING: "opening",
            OPENED: "opened",
            CLOSING: "closing"
        }

        var transition = {
            OPEN: "open",
            OPENED: "opened",
            CLOSE: "close",
            CLOSED: "closed"
        }

        var currentState = state.CLOSED;

        var houseMachine = XState.Machine({
            id: "house",
            initial: currentState,
            states: {
                [state.CLOSED]: { on: { [transition.OPEN]: state.OPENING } },
                [state.OPENING]: { on: { [transition.OPENED]: state.OPENED } },
                [state.OPENED]: { on: { [transition.CLOSE]: state.CLOSING } },
                [state.CLOSING]: { on: { [transition.CLOSED]: state.CLOSED } }
            }
        });

        var houseService = XState.interpret(houseMachine).onTransition(state => handleState(state.value)).start();

        function handleState(s) {
            currentState = s;
            if (s === state.OPENING || s === state.CLOSING) {
                house.setAttribute("animation-mixer", "clip: " + s + "; clampWhenFinished: true; loop: once;");
            }
        }

        house.addEventListener("click", function() {
            switch (currentState) {
                case state.OPENING:
                    houseService.send(transition.OPENED);
                    break;
                case state.CLOSING:
                    houseService.send(transition.CLOSED);
                    break;
            }
        });

        scene.addEventListener("click", function() {
            switch (currentState) {
                case state.CLOSED:
                    houseService.send(transition.OPEN);
                    carousel.setAttribute("animation__scale", "property: scale; from: '0.01 0.01 0.01'; to: '1 1 1'; dur: 6000; loop: once; autoplay: true;");
                    carousel.setAttribute("animation__scale", "property: position; from: '0 0.1 0'; to: '0 0.3 0'; dur: 6000; loop: once; autoplay: true;");
                    break;
                case state.OPENED:
                    houseService.send(transition.CLOSE);
                    carousel.setAttribute("animation__scale", "property: scale; from: '1 1 1'; to: '0.01 0.01 0.01'; dur: 6000; loop: once; autoplay: true;");
                    carousel.setAttribute("animation__scale", "property: position; from: '0 0.3 0'; to: '0 0.1 0'; dur: 6000; loop: once; autoplay: true;");
                    break;
            }
        });
    </script>
</body>

</html>